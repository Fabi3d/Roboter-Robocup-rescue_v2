#include "motorsteuerung.h"
#include "neopixels.h"
#include "tcs230.h"
#include <Pixy2.h>        //Librarys
#include <Servo.h>

Pixy2 pixy;  //pixy-object
int La;
int Li;                     //Lightsensors
int Mi;
int Ri;
int Ra;
int R = 0;
int grenzLa = 320;         //set sensortresholds
int grenzLi = 320;         //set sensortresholds
int grenzMi = 300;
int grenzRi = 320;
int grenzRa = 320;  
Servo Servo1;
Servo Servo2;

void setup() {
  // put your setup code here, to run once:
          pinMode(SENSOR_S0, OUTPUT);
          pinMode(SENSOR_S1, OUTPUT);
          pinMode(SENSOR_S2, OUTPUT);
          pinMode(SENSOR_S3, OUTPUT);
          pinMode(SENSOR_OUT, INPUT);
   // Setting frequency-scaling to 20%
          digitalWrite(SENSOR_S0, HIGH);
          digitalWrite(SENSOR_S1, LOW);
                              pinMode(linksV, OUTPUT);
                              pinMode(linksR, OUTPUT);
                              pinMode(rechtsV, OUTPUT);
                              pinMode(rechtsR, OUTPUT);
                              
  pinMode(A0, INPUT);           //sensoren als input definieren
  pinMode(A1, INPUT);
  pinMode(A2, INPUT);
  pinMode(A3, INPUT);
  pinMode(A4, INPUT);
  pinMode(A5, INPUT);

   pixels.begin();
  
  Serial.begin(115200);
  Serial.print("Starting...\n");
 
  // initialize the pixy object 
              pixy.init();
              // using the color connected components program
              pixy.changeProg("color_connected_components");
              pixy.setLamp(1, 1);         //activate the led´s
              delay(1000);

}

void loop() {
  // put your main code here, to run repeatedly:
  setPixelBlue();
 auslesen();
  static int i = 0;
  int j;
  char buf[64]; 
  int32_t panOffset, tiltOffset;
  
  if(La>grenzLa && Li>grenzLi  && Mi>grenzMi && Ri>grenzRi && Ra>grenzRa)
{  
unsigned long  Nowtime = millis();

  auslesen();
  while((La>grenzLa && Li>grenzLi  && Mi>grenzMi && Ri>grenzRi && Ra>grenzRa))      
  {
    Serial.println(Nowtime);
    auslesen();
    gerade();
    tcs();
  /*  if( f1+f2+f3 < 4500)
{
//  Raum();
}*/
    if(millis() - Nowtime >= 1000)
    {
    
      while(La>grenzLa && Li>grenzLi  && Mi>grenzMi && Ri>grenzRi && Ra>grenzRa)
      {
        auslesen();
      back();
      Serial.println("back");
      delay(100);
      }
      
    }
  }
}
  auslesen();
   if((La>grenzLa && Li>grenzLi && Mi<grenzMi && Ri>grenzRi && Ra>grenzRa)  || (La>grenzLa && Li<grenzLi && Mi<grenzMi && Ri<grenzRi && Ra>grenzRa) ) //alle bedingungen für gerade gerade aus
  {
      gerade();
   }
   auslesen();
if((La>grenzLa && Li<grenzLi && Mi>grenzMi && Ri>grenzRi && Ra>grenzRa) || (La>grenzLa && Li<grenzLi && Mi<grenzMi && Ri>grenzRi && Ra>grenzRa))          //wenn der seonsor li/li+mi auf schwarz ist
  {

   
      auslesen();
      dreheLinks();
    
  }
auslesen();
  if((La>grenzLa && Li>grenzLi && Mi>grenzMi && Ri<grenzRi && Ra>grenzRa) || (La>grenzLa && Li>grenzLi && Mi<grenzMi && Ri<grenzRi && Ra>grenzRa))        //wenn der sensor ri/ri+mi schwarz ist
  {
   
 
      auslesen();
      dreheRechts();
    
  }

auslesen();
 if((La<grenzLa && Li>grenzLi && Mi>grenzMi && Ri>grenzRi && Ra>grenzRa) || (La<grenzLa && Li<grenzLi && Mi>grenzMi && Ri>grenzRi && Ra>grenzRa))          //wenn der seonsor la/la+li auf schwarz ist
 {

      auslesen();
      dreheStarkLinks();
    
  }
auslesen();
  if((La>grenzLa && Li>grenzLi && Mi>grenzMi && Ri>grenzRi && Ra<grenzRa) || (La>grenzLa && Li>grenzLi && Mi>grenzMi && Ri<grenzRi && Ra<grenzRa))        //wenn der sensor ra/ra+ri schwarz ist
  {
    

      auslesen();
      dreheStarkRechts();
    
  }
  auslesen();

  if(La<grenzLa && Li<grenzLi && Mi<grenzMi && Ri>grenzRi && Ra>grenzRa) 
  {
    gerade();
    delay(200);
    dreheStarkLinks();
    delay(150);
    auslesen();
    while(Mi>grenzMi)
    {
      auslesen();
      dreheStarkLinks();
    }
   back();
   delay(30);
  }
  auslesen();
    if(La>grenzLa && Li>grenzLi && Mi<grenzMi && Ri<grenzRi && Ra<grenzRa) 
  {
    gerade();
    delay(200);
    dreheStarkRechts();
    delay(150);
    auslesen();
    while(Mi>grenzMi)
    {
      auslesen();
      dreheStarkRechts();
    }
    back();
    delay(30);
  }
  auslesen();

      pixy.ccc.getBlocks();

  if (pixy.ccc.numBlocks)
  {        
    i++;
   
    panOffset = (int32_t)pixy.frameWidth/2 - (int32_t)pixy.ccc.blocks[0].m_x;
    tiltOffset = (int32_t)pixy.ccc.blocks[0].m_y - (int32_t)pixy.frameHeight/2;  
    pixy.ccc.getBlocks();
int   panOffset2 = (int32_t)pixy.frameWidth/2 - (int32_t)pixy.ccc.blocks[1].m_x;
int    tiltOffset2 = (int32_t)pixy.ccc.blocks[1].m_y - (int32_t)pixy.frameHeight/2;  
   
Serial.print(panOffset);
    Serial.print("       ");
    Serial.println(tiltOffset);
    if(panOffset<0&&tiltOffset>40)
    {
      back();
      delay(10);
      Stop();
      delay(500);
      auslesen();
      if(Ra<grenzRa&&Ri<grenzRi)
      {
        gerade();
        delay(700);
        auslesen();
        return;
      }
      gerade();
      delay(550);
      dreheStarkRechts();
      delay(800);
      auslesen();
     while(Mi>grenzMi && Li>grenzLi && La>grenzLa)
        {
                auslesen();
                dreheStarkRechts();
        }
        gerade();
        delay(250);
        return;
    }
     if(panOffset>0&&tiltOffset>40)
    {
      back();
      delay(10);
      Stop();
      delay(500);
      
      
      auslesen();
      if(La<grenzLa&&Li<grenzLi)
      {
        gerade();
        delay(700);
        auslesen();
       return;
      }
      gerade();
      delay(550);
      dreheStarkLinks();
      delay(800);
      auslesen();
      while(Mi>grenzMi&& Ri>grenzRi && Ra>grenzRa)
        {
                auslesen();
                dreheStarkLinks();
        }
        gerade();
        delay(250);
      return;
      
    }
    if(pixy.ccc.numBlocks==2)
    {
        if(tiltOffset>0&&tiltOffset2>0)
{
       turn();
      delay(800);
      auslesen();
      while(Mi>grenzMi)
      {
        dreheStarkRechts();
        auslesen();
      } 
}
else
{
  return;
}
}
}
}


void auslesen()
{
    
    Ra = analogRead(A4);
   Ri = analogRead(A3);
   Mi = analogRead(A2);
   Li = analogRead(A1);
   La= analogRead(A0);
//   irVal=  analogRead(A5);
    Serial.print(La);
    Serial.print("---");
    Serial.print(Li);
    Serial.print("---");
    Serial.print(Mi);
    Serial.print("---");
    Serial.print(Ri);
    Serial.print("---");
    Serial.println(Ra);
    Serial.print("           ");
//    Serial.println(irVal);
 
    }
